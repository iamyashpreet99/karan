<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Game - Player vs CPU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #87CEEB 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f5132 0%, #198754 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="white" opacity="0.3"/></svg>') repeat;
            opacity: 0.1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-screen {
            display: none;
            padding: 20px;
        }

        .game-screen.active {
            display: block;
        }

        /* Pre-match Setup */
        .setup-screen {
            padding: 30px;
        }

        .setup-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #198754;
        }

        .setup-section h2 {
            color: #0f5132;
            margin-bottom: 15px;
        }

        .team-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .team-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .team-card:hover {
            border-color: #198754;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .team-card.selected {
            border-color: #198754;
            background: #d1e7dd;
        }

        .format-selector {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .format-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .format-btn:hover {
            border-color: #198754;
        }

        .format-btn.selected {
            background: #198754;
            color: white;
            border-color: #198754;
        }

        .toss-section {
            text-align: center;
            padding: 20px;
        }

        .toss-btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            background: #198754;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toss-btn:hover {
            background: #0f5132;
            transform: scale(1.05);
        }

        .btn-primary {
            padding: 15px 40px;
            font-size: 1.2em;
            background: #198754;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px auto;
            display: block;
        }

        .btn-primary:hover {
            background: #0f5132;
            transform: scale(1.05);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Match Display */
        .scoreboard {
            background: linear-gradient(135deg, #0f5132 0%, #198754 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .scoreboard-main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .score-item {
            text-align: center;
        }

        .score-item h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .score-item .value {
            font-size: 2em;
            font-weight: bold;
        }

        .overs-display {
            font-size: 1.5em;
            text-align: center;
            margin-top: 10px;
        }

        .last-six-balls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .ball-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .ball-dot { background: #6c757d; color: white; }
        .ball-run { background: #ffc107; color: #000; }
        .ball-four { background: #0d6efd; color: white; }
        .ball-six { background: #dc3545; color: white; }
        .ball-wicket { background: #000; color: white; }

        .commentary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 60px;
            border-left: 4px solid #198754;
        }

        .commentary-text {
            font-style: italic;
            color: #495057;
        }

        /* Game Controls */
        .game-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: #0f5132;
            margin-bottom: 15px;
        }

        .shot-options, .bowling-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .action-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #198754;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .action-btn:hover {
            background: #198754;
            color: white;
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .current-players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .player-card h4 {
            color: #0f5132;
            margin-bottom: 10px;
        }

        .player-stats {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Match Summary */
        .match-summary {
            padding: 30px;
            text-align: center;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #198754;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background: #d1e7dd;
            color: #0f5132;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #198754;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .scoreboard-main {
                grid-template-columns: 1fr;
            }

            .shot-options, .bowling-options {
                grid-template-columns: 1fr;
            }
        }

        .animation-bounce {
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèè Cricket Game</h1>
            <p>Player vs CPU</p>
        </div>

        <!-- Pre-Match Setup Screen -->
        <div id="setupScreen" class="setup-screen game-screen active">
            <div class="setup-section">
                <h2>Select Your Team</h2>
                <div id="teamSelector" class="team-selector">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading teams...</p>
                    </div>
                </div>
            </div>

            <div class="setup-section">
                <h2>Select Match Format</h2>
                <div class="format-selector">
                    <button class="format-btn selected" data-format="T20">T20 (20 Overs)</button>
                    <button class="format-btn" data-format="ODI">ODI (50 Overs)</button>
                    <button class="format-btn" data-format="Test">Test (Simplified)</button>
                </div>
            </div>

            <div class="setup-section">
                <h2>Select AI Difficulty</h2>
                <div class="format-selector">
                    <button class="format-btn" data-difficulty="Easy">Easy</button>
                    <button class="format-btn selected" data-difficulty="Medium">Medium</button>
                    <button class="format-btn" data-difficulty="Hard">Hard</button>
                </div>
            </div>

            <button id="startMatchBtn" class="btn-primary" disabled>Start Match</button>
        </div>

        <!-- Toss Screen -->
        <div id="tossScreen" class="setup-screen game-screen">
            <div class="toss-section">
                <h2>Coin Toss</h2>
                <p>Choose heads or tails</p>
                <button class="toss-btn" data-choice="Heads">Heads</button>
                <button class="toss-btn" data-choice="Tails">Tails</button>
                <div id="tossResult" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Match Screen -->
        <div id="matchScreen" class="game-screen">
            <div class="scoreboard">
                <div class="scoreboard-main">
                    <div class="score-item">
                        <h3 id="battingTeamName">Team 1</h3>
                        <div class="value" id="currentScore">0/0</div>
                    </div>
                    <div class="score-item">
                        <h3>Overs</h3>
                        <div class="value" id="currentOvers">0.0</div>
                    </div>
                    <div class="score-item" id="targetScoreItem" style="display: none;">
                        <h3>Target</h3>
                        <div class="value" id="targetScore">0</div>
                    </div>
                    <div class="score-item" id="requiredRRItem" style="display: none;">
                        <h3>Required RR</h3>
                        <div class="value" id="requiredRR">0.00</div>
                    </div>
                </div>
                <div class="overs-display" id="oversDisplay">0.0 / 20.0</div>
                <div class="last-six-balls" id="lastSixBalls"></div>
            </div>

            <div class="commentary" id="commentary">
                <div class="commentary-text">Match about to begin...</div>
            </div>

            <div class="current-players" id="currentPlayers"></div>

            <div class="game-controls" id="gameControls">
                <!-- Controls will be dynamically generated -->
            </div>
        </div>

        <!-- Match Summary Screen -->
        <div id="summaryScreen" class="game-screen">
            <div class="match-summary">
                <h2>Match Summary</h2>
                <div class="summary-card" id="summaryContent"></div>
                <button class="btn-primary" onclick="location.reload()">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Game State Management
        const gameState = {
            playerTeam: null,
            cpuTeam: null,
            matchFormat: 'T20',
            difficulty: 'Medium',
            tossWonBy: null,
            battingFirst: null,
            currentInnings: 1,
            playerBatting: false,
            overs: 0,
            balls: 0,
            totalOvers: 20,
            wickets: 0,
            runs: 0,
            target: null,
            lastSixBalls: [],
            currentBatsman1: null,
            currentBatsman2: null,
            currentBowler: null,
            playerSquad: [],
            cpuSquad: [],
            playerStats: {},
            cpuStats: {},
            matchHistory: []
        };

        // Static Team Data (Fallback)
        const staticTeams = {
            'India': {
                name: 'India',
                players: [
                    { name: 'Rohit Sharma', role: 'Batsman', batting: 85, bowling: 20 },
                    { name: 'Virat Kohli', role: 'Batsman', batting: 90, bowling: 25 },
                    { name: 'KL Rahul', role: 'Batsman', batting: 82, bowling: 15 },
                    { name: 'Suryakumar Yadav', role: 'Batsman', batting: 88, bowling: 20 },
                    { name: 'Rishabh Pant', role: 'Wicketkeeper', batting: 80, bowling: 10 },
                    { name: 'Hardik Pandya', role: 'All-rounder', batting: 75, bowling: 78 },
                    { name: 'Ravindra Jadeja', role: 'All-rounder', batting: 70, bowling: 82 },
                    { name: 'Jasprit Bumrah', role: 'Bowler', batting: 25, bowling: 92 },
                    { name: 'Mohammed Shami', role: 'Bowler', batting: 30, bowling: 88 },
                    { name: 'Yuzvendra Chahal', role: 'Bowler', batting: 20, bowling: 85 },
                    { name: 'Kuldeep Yadav', role: 'Bowler', batting: 22, bowling: 83 }
                ]
            },
            'Australia': {
                name: 'Australia',
                players: [
                    { name: 'David Warner', role: 'Batsman', batting: 88, bowling: 20 },
                    { name: 'Steve Smith', role: 'Batsman', batting: 89, bowling: 25 },
                    { name: 'Marnus Labuschagne', role: 'Batsman', batting: 85, bowling: 30 },
                    { name: 'Glenn Maxwell', role: 'All-rounder', batting: 82, bowling: 75 },
                    { name: 'Alex Carey', role: 'Wicketkeeper', batting: 75, bowling: 10 },
                    { name: 'Marcus Stoinis', role: 'All-rounder', batting: 78, bowling: 72 },
                    { name: 'Pat Cummins', role: 'Bowler', batting: 40, bowling: 90 },
                    { name: 'Mitchell Starc', role: 'Bowler', batting: 35, bowling: 91 },
                    { name: 'Josh Hazlewood', role: 'Bowler', batting: 28, bowling: 89 },
                    { name: 'Adam Zampa', role: 'Bowler', batting: 22, bowling: 84 },
                    { name: 'Nathan Lyon', role: 'Bowler', batting: 25, bowling: 86 }
                ]
            },
            'England': {
                name: 'England',
                players: [
                    { name: 'Jos Buttler', role: 'Wicketkeeper', batting: 90, bowling: 15 },
                    { name: 'Jonny Bairstow', role: 'Batsman', batting: 87, bowling: 20 },
                    { name: 'Joe Root', role: 'Batsman', batting: 88, bowling: 45 },
                    { name: 'Ben Stokes', role: 'All-rounder', batting: 85, bowling: 80 },
                    { name: 'Liam Livingstone', role: 'All-rounder', batting: 80, bowling: 70 },
                    { name: 'Moeen Ali', role: 'All-rounder', batting: 75, bowling: 78 },
                    { name: 'Sam Curran', role: 'All-rounder', batting: 70, bowling: 82 },
                    { name: 'Jofra Archer', role: 'Bowler', batting: 30, bowling: 91 },
                    { name: 'Mark Wood', role: 'Bowler', batting: 25, bowling: 88 },
                    { name: 'Adil Rashid', role: 'Bowler', batting: 20, bowling: 85 },
                    { name: 'Chris Woakes', role: 'Bowler', batting: 35, bowling: 84 }
                ]
            },
            'Pakistan': {
                name: 'Pakistan',
                players: [
                    { name: 'Babar Azam', role: 'Batsman', batting: 92, bowling: 20 },
                    { name: 'Mohammad Rizwan', role: 'Wicketkeeper', batting: 85, bowling: 10 },
                    { name: 'Fakhar Zaman', role: 'Batsman', batting: 83, bowling: 25 },
                    { name: 'Iftikhar Ahmed', role: 'All-rounder', batting: 78, bowling: 70 },
                    { name: 'Shadab Khan', role: 'All-rounder', batting: 72, bowling: 82 },
                    { name: 'Imad Wasim', role: 'All-rounder', batting: 70, bowling: 80 },
                    { name: 'Shaheen Afridi', role: 'Bowler', batting: 28, bowling: 90 },
                    { name: 'Haris Rauf', role: 'Bowler', batting: 25, bowling: 88 },
                    { name: 'Naseem Shah', role: 'Bowler', batting: 22, bowling: 87 },
                    { name: 'Mohammad Nawaz', role: 'Bowler', batting: 30, bowling: 81 },
                    { name: 'Hasan Ali', role: 'Bowler', batting: 32, bowling: 85 }
                ]
            },
            'New Zealand': {
                name: 'New Zealand',
                players: [
                    { name: 'Kane Williamson', role: 'Batsman', batting: 89, bowling: 35 },
                    { name: 'Devon Conway', role: 'Batsman', batting: 84, bowling: 20 },
                    { name: 'Daryl Mitchell', role: 'All-rounder', batting: 80, bowling: 65 },
                    { name: 'Glenn Phillips', role: 'Batsman', batting: 82, bowling: 40 },
                    { name: 'Tom Latham', role: 'Wicketkeeper', batting: 78, bowling: 10 },
                    { name: 'Mitchell Santner', role: 'All-rounder', batting: 70, bowling: 83 },
                    { name: 'James Neesham', role: 'All-rounder', batting: 75, bowling: 72 },
                    { name: 'Trent Boult', role: 'Bowler', batting: 30, bowling: 90 },
                    { name: 'Tim Southee', role: 'Bowler', batting: 35, bowling: 88 },
                    { name: 'Lockie Ferguson', role: 'Bowler', batting: 25, bowling: 87 },
                    { name: 'Ish Sodhi', role: 'Bowler', batting: 20, bowling: 84 }
                ]
            },
            'South Africa': {
                name: 'South Africa',
                players: [
                    { name: 'Quinton de Kock', role: 'Wicketkeeper', batting: 87, bowling: 10 },
                    { name: 'Temba Bavuma', role: 'Batsman', batting: 82, bowling: 20 },
                    { name: 'Aiden Markram', role: 'Batsman', batting: 85, bowling: 45 },
                    { name: 'Rassie van der Dussen', role: 'Batsman', batting: 83, bowling: 25 },
                    { name: 'David Miller', role: 'Batsman', batting: 84, bowling: 30 },
                    { name: 'Marco Jansen', role: 'All-rounder', batting: 65, bowling: 82 },
                    { name: 'Kagiso Rabada', role: 'Bowler', batting: 32, bowling: 91 },
                    { name: 'Anrich Nortje', role: 'Bowler', batting: 25, bowling: 89 },
                    { name: 'Lungi Ngidi', role: 'Bowler', batting: 28, bowling: 86 },
                    { name: 'Tabraiz Shamsi', role: 'Bowler', batting: 20, bowling: 85 },
                    { name: 'Keshav Maharaj', role: 'Bowler', batting: 25, bowling: 83 }
                ]
            }
        };

        // Initialize Game
        function initGame() {
            loadTeams();
            setupEventListeners();
            // Set default format and difficulty as selected
            document.querySelector('.format-btn[data-format="T20"]').classList.add('selected');
            document.querySelector('.format-btn[data-difficulty="Medium"]').classList.add('selected');
        }

        // Load Teams
        async function loadTeams() {
            const teamSelector = document.getElementById('teamSelector');
            
            if (!teamSelector) {
                console.error('Team selector element not found!');
                return;
            }
            
            try {
                // Try to fetch from API (if available)
                // For now, using static data
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API call
                
                displayTeams();
            } catch (error) {
                console.error('Error loading teams:', error);
                displayTeams(); // Fallback to static data
            }
        }

        function displayTeams() {
            const teamSelector = document.getElementById('teamSelector');
            if (!teamSelector) {
                console.error('Team selector element not found in displayTeams!');
                return;
            }
            
            teamSelector.innerHTML = '';
            
            Object.keys(staticTeams).forEach(teamName => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.textContent = teamName;
                teamCard.onclick = () => selectTeam(teamName, teamCard);
                teamSelector.appendChild(teamCard);
            });
        }

        function selectTeam(teamName, element) {
            gameState.playerTeam = teamName;
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            } else {
                // Fallback: find the card by text content
                document.querySelectorAll('.team-card').forEach(card => {
                    if (card.textContent.trim() === teamName) {
                        card.classList.add('selected');
                    }
                });
            }
            checkStartButton();
        }

        function setupEventListeners() {
            // Format selection
            document.querySelectorAll('.format-btn[data-format]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.format-btn[data-format]').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    gameState.matchFormat = e.target.dataset.format;
                    gameState.totalOvers = gameState.matchFormat === 'T20' ? 20 : gameState.matchFormat === 'ODI' ? 50 : 90;
                    checkStartButton();
                });
            });

            // Difficulty selection
            document.querySelectorAll('.format-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.format-btn[data-difficulty]').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    gameState.difficulty = e.target.dataset.difficulty;
                    checkStartButton();
                });
            });

            // Start match button
            document.getElementById('startMatchBtn').addEventListener('click', startMatch);

            // Toss buttons
            document.querySelectorAll('.toss-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    performToss(e.target.dataset.choice);
                });
            });
        }

        function checkStartButton() {
            const btn = document.getElementById('startMatchBtn');
            if (gameState.playerTeam && gameState.matchFormat && gameState.difficulty) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function startMatch() {
            // Select random CPU team
            const availableTeams = Object.keys(staticTeams).filter(t => t !== gameState.playerTeam);
            gameState.cpuTeam = availableTeams[Math.floor(Math.random() * availableTeams.length)];
            
            // Initialize squads
            gameState.playerSquad = [...staticTeams[gameState.playerTeam].players];
            gameState.cpuSquad = [...staticTeams[gameState.cpuTeam].players];
            
            // Initialize stats
            gameState.playerSquad.forEach(p => {
                gameState.playerStats[p.name] = { runs: 0, balls: 0, fours: 0, sixes: 0, wickets: 0 };
            });
            gameState.cpuSquad.forEach(p => {
                gameState.cpuStats[p.name] = { runs: 0, balls: 0, fours: 0, sixes: 0, wickets: 0 };
            });

            // Show toss screen
            showScreen('tossScreen');
        }

        function performToss(playerChoice) {
            const tossResult = Math.random() < 0.5 ? 'Heads' : 'Tails';
            const playerWon = tossResult === playerChoice;
            
            gameState.tossWonBy = playerWon ? 'Player' : 'CPU';
            gameState.battingFirst = playerWon ? 'Player' : 'CPU';
            gameState.playerBatting = playerWon;
            
            const resultDiv = document.getElementById('tossResult');
            resultDiv.innerHTML = `
                <div class="success-message">
                    <p><strong>Toss Result:</strong> ${tossResult}</p>
                    <p>${playerWon ? 'You won the toss!' : 'CPU won the toss!'}</p>
                    <p>${gameState.battingFirst} will bat first.</p>
                    <button class="btn-primary" onclick="startInnings()" style="margin-top: 15px;">Start Match</button>
                </div>
            `;
        }

        function startInnings() {
            showScreen('matchScreen');
            initializeInnings();
        }

        function initializeInnings() {
            gameState.overs = 0;
            gameState.balls = 0;
            gameState.wickets = 0;
            gameState.runs = 0;
            gameState.lastSixBalls = [];
            gameState.currentBatsman1 = null;
            gameState.currentBatsman2 = null;
            gameState.currentBowler = null;
            
            if (gameState.playerBatting) {
                // Player batting
                setBatsmen('player');
                setBowler('cpu');
                updateScoreboard();
                showBattingControls();
            } else {
                // CPU batting
                setBatsmen('cpu');
                setBowler('player');
                updateScoreboard();
                showBowlingControls();
                // CPU plays automatically
                setTimeout(() => cpuPlayBall(), 1000);
            }
        }

        function setBatsmen(team) {
            const squad = team === 'player' ? gameState.playerSquad : gameState.cpuSquad;
            const stats = team === 'player' ? gameState.playerStats : gameState.cpuStats;
            const availableBatsmen = squad.filter((p, idx) => idx < 11 && !stats[p.name]?.out);
            
            if (!gameState.currentBatsman1) {
                gameState.currentBatsman1 = availableBatsmen[0];
            }
            if (!gameState.currentBatsman2) {
                gameState.currentBatsman2 = availableBatsmen[1];
            }
            
            updatePlayersDisplay();
        }

        function setBowler(team) {
            const squad = team === 'player' ? gameState.playerSquad : gameState.cpuSquad;
            const bowlers = squad.filter(p => p.bowling >= 70);
            gameState.currentBowler = bowlers[Math.floor(Math.random() * bowlers.length)];
            updatePlayersDisplay();
        }

        function updatePlayersDisplay() {
            const playersDiv = document.getElementById('currentPlayers');
            playersDiv.innerHTML = '';
            
            if (gameState.currentBatsman1) {
                const batsman1Card = createPlayerCard(gameState.currentBatsman1, 'Batsman 1');
                playersDiv.appendChild(batsman1Card);
            }
            
            if (gameState.currentBatsman2) {
                const batsman2Card = createPlayerCard(gameState.currentBatsman2, 'Batsman 2');
                playersDiv.appendChild(batsman2Card);
            }
            
            if (gameState.currentBowler) {
                const bowlerCard = createPlayerCard(gameState.currentBowler, 'Bowler');
                playersDiv.appendChild(bowlerCard);
            }
        }

        function createPlayerCard(player, role) {
            const card = document.createElement('div');
            card.className = 'player-card';
            const stats = gameState.playerBatting ? 
                (gameState.playerStats[player.name] || {}) : 
                (gameState.cpuStats[player.name] || {});
            
            card.innerHTML = `
                <h4>${player.name} (${role})</h4>
                <div class="player-stats">
                    <p>Batting: ${player.batting} | Bowling: ${player.bowling}</p>
                    ${stats.runs !== undefined ? `<p>Runs: ${stats.runs} (${stats.balls}) | 4s: ${stats.fours} | 6s: ${stats.sixes}</p>` : ''}
                </div>
            `;
            return card;
        }

        function showBattingControls() {
            const controlsDiv = document.getElementById('gameControls');
            controlsDiv.innerHTML = `
                <div class="control-section">
                    <h3>Choose Your Shot</h3>
                    <div class="shot-options">
                        <button class="action-btn" onclick="playShot('defensive')">üõ°Ô∏è Defensive</button>
                        <button class="action-btn" onclick="playShot('aggressive')">‚ö° Aggressive</button>
                        <button class="action-btn" onclick="playShot('lofted')">üöÄ Lofted Shot</button>
                        <button class="action-btn" onclick="playShot('quick')">üèÉ Quick Single</button>
                    </div>
                </div>
            `;
        }

        function showBowlingControls() {
            const controlsDiv = document.getElementById('gameControls');
            const bowlers = gameState.playerSquad.filter(p => p.bowling >= 70);
            
            controlsDiv.innerHTML = `
                <div class="control-section">
                    <h3>Select Bowler</h3>
                    <div class="shot-options" id="bowlerSelector">
                        ${bowlers.map(bowler => 
                            `<button class="action-btn" onclick="selectBowler('${bowler.name}')">${bowler.name} (${bowler.bowling})</button>`
                        ).join('')}
                    </div>
                </div>
                <div class="control-section" id="bowlingOptions" style="display: none;">
                    <h3>Choose Bowling Type</h3>
                    <div class="shot-options">
                        <button class="action-btn" onclick="playBowling('fast')">‚ö° Fast/Pace</button>
                        <button class="action-btn" onclick="playBowling('spin')">üåÄ Spin</button>
                        <button class="action-btn" onclick="playBowling('slower')">üêå Slower Ball</button>
                        <button class="action-btn" onclick="playBowling('yorker')">üéØ Yorker/Bouncer</button>
                    </div>
                </div>
            `;
        }

        function selectBowler(bowlerName) {
            gameState.currentBowler = gameState.playerSquad.find(p => p.name === bowlerName);
            document.getElementById('bowlerSelector').style.display = 'none';
            document.getElementById('bowlingOptions').style.display = 'block';
            updatePlayersDisplay();
        }

        // Probability Engine
        function calculateOutcome(shotType, batsman, bowler, isPlayerBatting) {
            const baseProbabilities = {
                defensive: { dot: 0.5, single: 0.3, boundary: 0.1, wicket: 0.1 },
                aggressive: { dot: 0.2, single: 0.2, boundary: 0.4, wicket: 0.2 },
                lofted: { dot: 0.1, single: 0.1, boundary: 0.5, wicket: 0.3 },
                quick: { dot: 0.3, single: 0.5, boundary: 0.1, wicket: 0.1 }
            };

            const probs = baseProbabilities[shotType] || baseProbabilities.defensive;
            
            // Adjust based on player ratings
            const skillDiff = (batsman.batting - bowler.bowling) / 100;
            
            // Adjust for difficulty when CPU is batting
            let difficultyAdjustment = 0;
            if (!isPlayerBatting) {
                if (gameState.difficulty === 'Easy') {
                    difficultyAdjustment = -0.1; // CPU bats worse
                } else if (gameState.difficulty === 'Hard') {
                    difficultyAdjustment = 0.1; // CPU bats better
                }
            }
            
            const adjustedProbs = {
                dot: Math.max(0.1, probs.dot + skillDiff * 0.2 + difficultyAdjustment),
                single: probs.single + skillDiff * 0.1,
                boundary: Math.max(0.05, probs.boundary - skillDiff * 0.1 - difficultyAdjustment),
                wicket: Math.max(0.05, probs.wicket - skillDiff * 0.1 + difficultyAdjustment)
            };

            // Normalize probabilities
            const total = adjustedProbs.dot + adjustedProbs.single + adjustedProbs.boundary + adjustedProbs.wicket;
            Object.keys(adjustedProbs).forEach(key => adjustedProbs[key] /= total);

            // Determine outcome
            const rand = Math.random();
            if (rand < adjustedProbs.wicket) {
                return { type: 'wicket', runs: 0, message: getWicketMessage() };
            } else if (rand < adjustedProbs.wicket + adjustedProbs.dot) {
                return { type: 'dot', runs: 0, message: `${batsman.name} defends it back to the bowler.` };
            } else if (rand < adjustedProbs.wicket + adjustedProbs.dot + adjustedProbs.single) {
                const runs = Math.random() < 0.7 ? 1 : (Math.random() < 0.9 ? 2 : 3);
                return { type: 'run', runs: runs, message: `${batsman.name} takes ${runs} run${runs > 1 ? 's' : ''}.` };
            } else {
                const isSix = shotType === 'lofted' || Math.random() < 0.4;
                return { 
                    type: isSix ? 'six' : 'four', 
                    runs: isSix ? 6 : 4, 
                    message: isSix ? 
                        `SIX! ${batsman.name} sends it over the boundary!` : 
                        `FOUR! ${batsman.name} finds the boundary!` 
                };
            }
        }

        function getWicketMessage() {
            const messages = [
                'Bowled! The stumps are shattered!',
                'Caught! The fielder takes a brilliant catch!',
                'LBW! The umpire raises his finger!',
                'Run out! Direct hit from the fielder!',
                'Stumped! Quick work by the wicketkeeper!'
            ];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function playShot(shotType) {
            if (gameState.wickets >= 10 || gameState.overs >= gameState.totalOvers) {
                endInnings();
                return;
            }

            const batsman = gameState.currentBatsman1;
            const outcome = calculateOutcome(shotType, batsman, gameState.currentBowler, true);
            
            processBall(outcome, true);
        }

        function playBowling(bowlingType) {
            if (gameState.wickets >= 10 || gameState.overs >= gameState.totalOvers) {
                endInnings();
                return;
            }

            // CPU decides shot based on AI
            const cpuShot = cpuChooseShot();
            const batsman = gameState.currentBatsman1;
            const outcome = calculateOutcome(cpuShot, batsman, gameState.currentBowler, false);
            
            processBall(outcome, false);
        }

        function cpuChooseShot() {
            const requiredRR = calculateRequiredRR();
            const oversLeft = gameState.totalOvers - (gameState.overs + gameState.balls / 6);
            const wicketsLeft = 10 - gameState.wickets;
            
            // Adjust AI based on difficulty
            let difficultyMultiplier = 1.0;
            if (gameState.difficulty === 'Easy') {
                difficultyMultiplier = 0.7; // Less aggressive, more mistakes
            } else if (gameState.difficulty === 'Hard') {
                difficultyMultiplier = 1.3; // More aggressive, better decisions
            }
            
            // AI logic based on match situation
            if (requiredRR > 10 * difficultyMultiplier || oversLeft < 5) {
                return Math.random() < (0.6 * difficultyMultiplier) ? 'aggressive' : 'lofted';
            } else if (requiredRR > 7 * difficultyMultiplier) {
                return Math.random() < (0.5 * difficultyMultiplier) ? 'aggressive' : 'quick';
            } else if (wicketsLeft <= 2) {
                return 'defensive';
            } else {
                return Math.random() < (0.4 / difficultyMultiplier) ? 'defensive' : 'quick';
            }
        }

        function cpuPlayBall() {
            if (gameState.wickets >= 10 || gameState.overs >= gameState.totalOvers) {
                endInnings();
                return;
            }

            // Auto-select bowler if not set
            if (!gameState.currentBowler) {
                const bowlers = gameState.playerSquad.filter(p => p.bowling >= 70);
                gameState.currentBowler = bowlers[Math.floor(Math.random() * bowlers.length)];
            }

            const cpuShot = cpuChooseShot();
            const batsman = gameState.currentBatsman1;
            const outcome = calculateOutcome(cpuShot, batsman, gameState.currentBowler, false);
            
            processBall(outcome, false);
        }

        function processBall(outcome, isPlayerAction) {
            // Update runs
            gameState.runs += outcome.runs;
            
            // Update ball count
            gameState.balls++;
            if (gameState.balls >= 6) {
                gameState.balls = 0;
                gameState.overs++;
                // Swap batsmen after over (only if odd runs or dot ball)
                if (outcome.runs % 2 === 1 || outcome.runs === 0) {
                    [gameState.currentBatsman1, gameState.currentBatsman2] = 
                        [gameState.currentBatsman2, gameState.currentBatsman1];
                }
            } else if (outcome.runs % 2 === 1) {
                // Swap batsmen on odd runs
                [gameState.currentBatsman1, gameState.currentBatsman2] = 
                    [gameState.currentBatsman2, gameState.currentBatsman1];
            }

            // Update last six balls
            const ballSymbol = outcome.type === 'wicket' ? 'W' : 
                             outcome.type === 'six' ? '6' : 
                             outcome.type === 'four' ? '4' : 
                             outcome.runs > 0 ? outcome.runs.toString() : '.';
            gameState.lastSixBalls.push(ballSymbol);
            if (gameState.lastSixBalls.length > 6) {
                gameState.lastSixBalls.shift();
            }

            // Update player stats
            const batsman = gameState.currentBatsman1;
            const stats = gameState.playerBatting ? 
                gameState.playerStats[batsman.name] : 
                gameState.cpuStats[batsman.name];
            
            if (outcome.type === 'wicket') {
                gameState.wickets++;
                stats.balls++;
                stats.out = true;
                // Get next batsman
                const squad = gameState.playerBatting ? gameState.playerSquad : gameState.cpuSquad;
                const allStats = gameState.playerBatting ? gameState.playerStats : gameState.cpuStats;
                const availableBatsmen = squad.filter((p, idx) => idx < 11 && !allStats[p.name]?.out && p.name !== batsman.name);
                if (availableBatsmen.length > 0) {
                    gameState.currentBatsman1 = availableBatsmen[0];
                }
            } else {
                stats.runs += outcome.runs;
                stats.balls++;
                if (outcome.type === 'four') stats.fours++;
                if (outcome.type === 'six') stats.sixes++;
            }

            // Update commentary
            updateCommentary(outcome.message);

            // Update scoreboard
            updateScoreboard();

            // Check if innings should end
            if (gameState.wickets >= 10 || gameState.overs >= gameState.totalOvers) {
                setTimeout(() => endInnings(), 2000);
            } else if (!isPlayerAction && !gameState.playerBatting) {
                // Continue CPU batting
                setTimeout(() => cpuPlayBall(), 1500);
            }
        }

        function calculateRequiredRR() {
            if (!gameState.target) return 0;
            const runsNeeded = gameState.target - gameState.runs;
            const ballsLeft = (gameState.totalOvers - gameState.overs) * 6 - gameState.balls;
            return ballsLeft > 0 ? (runsNeeded / ballsLeft) * 6 : 0;
        }

        function updateCommentary(message) {
            const commentaryDiv = document.getElementById('commentary');
            commentaryDiv.innerHTML = `<div class="commentary-text">${message}</div>`;
            commentaryDiv.classList.add('animation-bounce');
            setTimeout(() => commentaryDiv.classList.remove('animation-bounce'), 500);
        }

        function updateScoreboard() {
            const battingTeam = gameState.playerBatting ? gameState.playerTeam : gameState.cpuTeam;
            document.getElementById('battingTeamName').textContent = battingTeam;
            document.getElementById('currentScore').textContent = `${gameState.runs}/${gameState.wickets}`;
            document.getElementById('currentOvers').textContent = `${gameState.overs}.${gameState.balls}`;
            document.getElementById('oversDisplay').textContent = 
                `${gameState.overs}.${gameState.balls} / ${gameState.totalOvers}.0`;

            // Update last six balls display
            const lastSixDiv = document.getElementById('lastSixBalls');
            lastSixDiv.innerHTML = '';
            gameState.lastSixBalls.forEach(ball => {
                const ballDiv = document.createElement('div');
                ballDiv.className = 'ball-indicator';
                if (ball === 'W') ballDiv.className += ' ball-wicket';
                else if (ball === '6') ballDiv.className += ' ball-six';
                else if (ball === '4') ballDiv.className += ' ball-four';
                else if (ball === '.') ballDiv.className += ' ball-dot';
                else ballDiv.className += ' ball-run';
                ballDiv.textContent = ball;
                lastSixDiv.appendChild(ballDiv);
            });

            // Show target if chasing
            if (gameState.target) {
                document.getElementById('targetScoreItem').style.display = 'block';
                document.getElementById('requiredRRItem').style.display = 'block';
                document.getElementById('targetScore').textContent = gameState.target;
                document.getElementById('requiredRR').textContent = calculateRequiredRR().toFixed(2);
            }

            updatePlayersDisplay();
        }

        function endInnings() {
            const inningsScore = {
                team: gameState.playerBatting ? gameState.playerTeam : gameState.cpuTeam,
                runs: gameState.runs,
                wickets: gameState.wickets,
                overs: `${gameState.overs}.${gameState.balls}`
            };

            gameState.matchHistory.push(inningsScore);

            if (gameState.currentInnings === 1) {
                // First innings complete, set target
                gameState.target = gameState.runs + 1;
                gameState.currentInnings = 2;
                gameState.playerBatting = !gameState.playerBatting;
                
                // Reset for second innings
                gameState.overs = 0;
                gameState.balls = 0;
                gameState.wickets = 0;
                gameState.runs = 0;
                gameState.lastSixBalls = [];
                gameState.currentBatsman1 = null;
                gameState.currentBatsman2 = null;
                gameState.currentBowler = null;

                updateCommentary(`End of first innings! ${inningsScore.team} scored ${inningsScore.runs}/${inningsScore.wickets}. Target: ${gameState.target}`);
                
                setTimeout(() => {
                    initializeInnings();
                }, 3000);
            } else {
                // Match complete
                endMatch();
            }
        }

        function endMatch() {
            const playerScore = gameState.matchHistory.find(h => h.team === gameState.playerTeam);
            const cpuScore = gameState.matchHistory.find(h => h.team === gameState.cpuTeam);
            
            let winner = '';
            if (playerScore.runs > cpuScore.runs) {
                winner = gameState.playerTeam;
            } else if (cpuScore.runs > playerScore.runs) {
                winner = gameState.cpuTeam;
            } else {
                winner = 'Tie';
            }

            // Find man of the match
            let motm = null;
            let maxRuns = 0;
            Object.keys(gameState.playerStats).forEach(name => {
                const stats = gameState.playerStats[name];
                if (stats.runs > maxRuns) {
                    maxRuns = stats.runs;
                    motm = { name, stats, team: gameState.playerTeam };
                }
            });
            Object.keys(gameState.cpuStats).forEach(name => {
                const stats = gameState.cpuStats[name];
                if (stats.runs > maxRuns) {
                    maxRuns = stats.runs;
                    motm = { name, stats, team: gameState.cpuTeam };
                }
            });

            showScreen('summaryScreen');
            const summaryDiv = document.getElementById('summaryContent');
            summaryDiv.innerHTML = `
                <h3 style="font-size: 2em; margin-bottom: 20px; color: ${winner === gameState.playerTeam ? '#198754' : winner === gameState.cpuTeam ? '#dc3545' : '#ffc107'};">
                    ${winner === gameState.playerTeam ? 'üéâ You Won!' : winner === gameState.cpuTeam ? 'üòî CPU Won' : 'ü§ù Match Tied'}
                </h3>
                <div style="margin: 20px 0;">
                    <h4>${gameState.playerTeam}: ${playerScore.runs}/${playerScore.wickets} (${playerScore.overs})</h4>
                    <h4>${gameState.cpuTeam}: ${cpuScore.runs}/${cpuScore.wickets} (${cpuScore.overs})</h4>
                </div>
                ${motm ? `<div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <h4>Man of the Match: ${motm.name} (${motm.team})</h4>
                    <p>${motm.stats.runs} runs (${motm.stats.balls} balls) | ${motm.stats.fours} fours | ${motm.stats.sixes} sixes</p>
                </div>` : ''}
            `;

            // Save to localStorage
            try {
                const history = JSON.parse(localStorage.getItem('cricketMatchHistory') || '[]');
                history.push({
                    date: new Date().toISOString(),
                    playerTeam: gameState.playerTeam,
                    cpuTeam: gameState.cpuTeam,
                    winner: winner,
                    playerScore: playerScore,
                    cpuScore: cpuScore
                });
                localStorage.setItem('cricketMatchHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Error saving match history:', e);
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Make functions globally accessible
        window.playShot = playShot;
        window.playBowling = playBowling;
        window.selectBowler = selectBowler;
        window.startInnings = startInnings;

        // Initialize game on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            initGame();
        }
    </script>
</body>
</html>
